# 智能作业批改系统 - 部署教程

## 🚀 快速部署（3步完成）

### ⚡ 本地开发部署

**最简单的方式：**

1. **复制整个项目文件夹到新电脑**
   - 直接复制整个文件夹即可

2. **安装 Node.js 环境**
   - 下载：https://nodejs.org/
   - 安装 Node.js 18 或更高版本

3. **安装依赖并启动**
   ```bash
   npm install
   npm run dev
   ```

✅ **完成！** 浏览器访问 http://localhost:3000

---

### 🌟 生产环境稳定部署（推荐）

**使用云服务器实现7×24小时稳定运行**

#### 第一步：购买云服务器

**推荐服务商：**
- 🔵 **阿里云**（推荐）：https://www.aliyun.com/
  - 学生优惠：9.5元/月
  - 轻量应用服务器：60元起/年
  
- 🟢 **腾讯云**：https://cloud.tencent.com/
  - 学生机：10元/月
  - 轻量应用服务器：50元起/年
  
- 🟠 **华为云**：https://www.huaweicloud.com/
  - 新人优惠较多

**推荐配置：**
- CPU：1核
- 内存：1GB（最低配即可）
- 带宽：1Mbps
- 系统：Ubuntu 20.04 LTS 或 22.04 LTS
- 费用：约 ￥60-100/年

---

#### 第二步：连接服务器

**Windows 连接方式：**

1. **使用 SSH 工具**
   - 推荐工具：FinalShell（免费）、Xshell、PuTTY
   - 下载 FinalShell：https://www.hostbuf.com/

2. **连接信息**
   - IP地址：购买后在控制台查看
   - 端口：22
   - 用户名：root
   - 密码：购买时设置的密码

---

#### 第三步：服务器环境配置

登录服务器后，依次执行以下命令：

```bash
# 1. 更新系统
sudo apt update
sudo apt upgrade -y

# 2. 安装 Node.js 18（使用 NodeSource 源）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 3. 验证安装
node -v   # 应该显示 v18.x.x
npm -v    # 应该显示 9.x.x

# 4. 安装 PM2（进程管理工具）
sudo npm install -g pm2

# 5. 安装 Git（方便上传代码）
sudo apt install -y git
```

---

#### 第四步：上传项目文件

**方式1：使用 FinalShell 上传（推荐新手）**
1. 在 FinalShell 中连接服务器
2. 左侧是本地文件，右侧是服务器文件
3. 将项目文件夹拖拽到服务器的 `/root/` 目录

**方式2：使用 Git（推荐）**
```bash
# 在服务器上执行
cd /root
git clone 你的git仓库地址
```

**方式3：使用 SCP 命令（本地 PowerShell 执行）**
```powershell
# 压缩项目（本地执行）
# 然后上传
scp -r "项目文件夹路径" root@服务器IP:/root/
```

---

#### 第五步：配置项目

```bash
# 1. 进入项目目录
cd /root/Homework\ grading

# 2. 安装依赖
npm install

# 3. 配置环境变量
nano .env
# 按 Ctrl+X，然后 Y，然后 Enter 保存

# 4. 初始化数据库（如果需要）
npx prisma db push

# 5. 测试启动
npm run dev
```

如果能正常启动，按 `Ctrl+C` 停止，继续下一步。

---

#### 第六步：使用 PM2 部署（关键步骤）

```bash
# 1. 使用 PM2 启动项目
pm2 start npm --name "homework-system" -- run dev

# 2. 查看运行状态
pm2 status

# 3. 查看日志
pm2 logs homework-system

# 4. 设置开机自启
pm2 save
pm2 startup
# 会生成一行命令，复制执行它

# 5. 其他常用命令
pm2 restart homework-system  # 重启
pm2 stop homework-system     # 停止
pm2 delete homework-system   # 删除
pm2 monit                    # 监控
```

---

#### 第七步：配置防火墙

```bash
# 1. 开放 3000 端口（Ubuntu 防火墙）
sudo ufw allow 3000
sudo ufw enable
sudo ufw status

# 2. 在云服务器控制台也要开放端口
# 登录阿里云/腾讯云控制台
# 找到「安全组规则」
# 添加规则：入方向，TCP，端口 3000，授权对象 0.0.0.0/0
```

---

#### 第八步：访问测试

浏览器访问：`http://你的服务器IP:3000`

✅ 如果能看到登录页面，说明部署成功！

---

### 🌐 配置域名（可选但推荐）

#### 1. 购买域名

- 阿里云：https://wanwang.aliyun.com/
- 腾讯云：https://dnspod.cloud.tencent.com/
- 费用：约 ￥1-50/年（.com 域名约35元/年）

#### 2. 域名解析

在域名控制台添加 A 记录：
- 主机记录：`@`（代表根域名）或 `www`
- 记录类型：`A`
- 记录值：你的服务器公网IP
- TTL：600

#### 3. 配置 Nginx 反向代理

```bash
# 1. 安装 Nginx
sudo apt install -y nginx

# 2. 创建配置文件
sudo nano /etc/nginx/sites-available/homework

# 3. 添加以下内容：
server {
    listen 80;
    server_name 你的域名.com;  # 例如：homework.example.com

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

# 4. 启用配置
sudo ln -s /etc/nginx/sites-available/homework /etc/nginx/sites-enabled/

# 5. 测试配置
sudo nginx -t

# 6. 重启 Nginx
sudo systemctl restart nginx

# 7. 开放 80 端口
sudo ufw allow 80
```

现在访问 `http://你的域名.com` 即可！

---

### 🔒 配置 HTTPS（推荐）

```bash
# 1. 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 2. 获取 SSL 证书
sudo certbot --nginx -d 你的域名.com

# 3. 按提示输入邮箱，同意协议

# 4. 证书会自动续期，无需手动操作

# 5. 开放 443 端口
sudo ufw allow 443
```

现在访问 `https://你的域名.com` 即可安全访问！

---

## 📊 稳定部署方案对比

| 方案 | 稳定性 | 费用 | 难度 | 适用场景 |
|------|--------|------|------|----------|
| **云服务器** | ⭐⭐⭐⭐⭐ | ￥60-100/年 | ⭐⭐⭐ | ✅ **正式使用、长期运行** |
| 内网穿透 | ⭐⭐⭐ | 免费/付费 | ⭐ | 临时测试、个人学习 |
| 本地运行 | ⭐⭐ | 免费 | ⭐ | 开发调试 |

**云服务器优势：**
- ✅ 7×24小时稳定运行
- ✅ 固定公网IP，不会变化
- ✅ 可以绑定域名
- ✅ 支持HTTPS加密
- ✅ 访问速度快
- ✅ 专业、可靠

**云服务器缺点：**
- ⚠️ 需要一定的Linux基础（按教程操作即可）
- ⚠️ 需要付费（但很便宜，约60元/年）

---

## 📦 详细部署步骤

### 1️⃣ 环境准备

#### 必需软件
- **Node.js 18 或更高版本**
  - 下载地址：https://nodejs.org/
  - 安装后验证：在命令行运行 `node -v` 和 `npm -v`

- **数据库工具（可选）**
  - Prisma Studio（已包含在项目中）
  - 或 SQLite 数据库查看工具

---

### 2️⃣ 复制项目文件

**推荐：直接复制整个文件夹**

将整个项目文件夹复制到新电脑即可，所有配置和数据都会保留。

**重要文件说明：**
- ✅ `.env` - API密钥配置（必须复制）
- ✅ `dev.db` - 数据库文件（保留所有数据）
- ✅ `package.json` - 项目配置
- ⚠️ `node_modules/` - 可以不复制，重新 `npm install` 即可
- ⚠️ `uploads/` - 上传的图片，可以清空

> **小提示：** 如果文件夹太大，可以删除 `node_modules/` 和 `uploads/` 再复制，到新电脑后重新安装依赖。

---

### 3️⃣ 安装依赖

打开命令行（CMD/PowerShell/终端），进入项目目录：

```bash
cd "项目路径"
npm install
```

> **提示：** 首次安装可能需要 5-10 分钟，耐心等待

---

### 4️⃣ 配置环境变量

#### 检查 `.env` 文件

确保根目录有 `.env` 文件，包含以下配置：

```env
# OpenAI API 配置（必需）
OPENAI_API_KEY=你的OpenAI密钥
OPENAI_BASE_URL=https://api.openai.com/v1

# 百度 OCR 配置（可选，用于图片识别）
BAIDU_APP_ID=你的百度APP_ID
BAIDU_API_KEY=你的百度API_KEY
BAIDU_SECRET_KEY=你的百度SECRET_KEY

# 服务器端口（可选，默认3000）
PORT=3000
```

#### 获取 API 密钥

**OpenAI API（必需）：**
1. 访问：https://platform.openai.com/api-keys
2. 登录并创建新的 API Key
3. 复制密钥并粘贴到 `.env` 文件

**百度 OCR（可选）：**
1. 访问：https://cloud.baidu.com/product/ocr
2. 创建应用获取 APP_ID、API_KEY、SECRET_KEY
3. 填入 `.env` 文件

---

### 5️⃣ 数据库配置

#### 选项 A：使用原数据库（保留数据）
- 直接复制 `dev.db` 文件到新电脑
- 所有用户、题目、交易记录都会保留

#### 选项 B：创建新数据库（全新开始）
```bash
# 删除旧数据库（如果有）
# Windows: del dev.db
# Mac/Linux: rm dev.db

# 初始化新数据库
npx prisma db push

# （可选）填充测试数据
npx ts-node scripts/seed.ts
```

---

### 6️⃣ 启动项目

#### 开发模式（推荐测试使用）
```bash
npm run dev
```

#### 生产模式
```bash
# 1. 编译 TypeScript
npm run build

# 2. 启动服务器
npm start
```

---

### 7️⃣ 访问系统

浏览器打开：
- 本地访问：http://localhost:3000
- 局域网访问：http://你的IP地址:3000

**测试账户（如果使用了种子数据）：**
- 管理员：admin / admin123
- 学生：student1 / password123
- 教师：teacher1 / password123

---

## 🌐 局域网/公网访问配置

### 🌍 公网访问（推荐方案）

#### 方案1：cpolar 内网穿透（最简单，推荐）

**特点：**
- ✅ 无需公网IP
- ✅ 无需配置路由器
- ✅ 5分钟完成配置
- ⚠️ 免费版域名每次重启会变化，付费版可固定域名

**操作步骤：**

1. **下载安装 cpolar**
   - 官网：https://www.cpolar.com/
   - 下载并安装Windows版本

2. **注册并登录**
   - 访问官网注册账号
   - 安装后打开cpolar客户端登录

3. **启动项目**
   ```bash
   # 先启动你的项目
   npm run dev
   ```

4. **创建隧道**
   
   **方法A：使用命令行**
   ```bash
   cpolar http 3000
   ```
   
   **方法B：使用图形界面**
   - 打开cpolar客户端
   - 点击"隧道管理" → "创建隧道"
   - 协议类型：http
   - 本地地址：3000
   - 点击"启动"

5. **获取公网地址**
   - 启动成功后会显示公网地址
   - 例如：`https://xxxxx.r28.cpolar.top`
   - 任何人都可以通过这个地址访问你的系统

6. **固定域名（可选，需付费）**
   - 免费版每次重启域名会变
   - 付费版可以固定域名，例如：`https://my-homework.cpolar.cn`

---

#### 方案2：花生壳内网穿透

**特点：**
- ✅ 老牌服务，稳定性好
- ⚠️ 免费版有流量限制

**操作步骤：**

1. 下载：https://hsk.oray.com/
2. 注册并登录
3. 添加映射：3000端口 → 公网域名
4. 启动映射即可访问

---

#### 方案3：frp 自建穿透（技术要求高）

**前提：**
- 需要一台有公网IP的云服务器
- 需要配置frp服务端和客户端

**不推荐新手使用**，如需使用请参考frp官方文档。

---

#### 方案4：云服务器部署（最稳定）

**购买云服务器：**
- 阿里云：https://www.aliyun.com/
- 腾讯云：https://cloud.tencent.com/
- 华为云：https://www.huaweicloud.com/

**优点：**
- ✅ 固定公网IP和域名
- ✅ 7×24小时运行
- ✅ 更稳定、更专业

**缺点：**
- ⚠️ 需要购买服务器（最低配约￥100/年）
- ⚠️ 需要备案域名（企业使用）

**部署步骤：**
1. 购买云服务器（Ubuntu 20.04推荐）
2. 安装Node.js环境
3. 上传项目文件
4. 配置环境变量
5. 使用PM2部署：
   ```bash
   npm install -g pm2
   pm2 start npm --name "homework" -- run dev
   pm2 save
   pm2 startup
   ```
6. 配置域名解析
7. （可选）配置HTTPS证书

---

### 📱 局域网访问

1. **确认项目已启动在 0.0.0.0**
   - 项目已配置，无需修改

2. **配置防火墙（Windows）**
   ```cmd
   # 以管理员身份运行命令行
   netsh advfirewall firewall add rule name="Node.js Port 3000" dir=in action=allow protocol=TCP localport=3000
   ```

3. **查看本机IP地址**
   ```cmd
   ipconfig
   ```
   找到 `IPv4 地址`，例如：192.168.1.100

4. **其他设备访问**
   - 连接到同一 WiFi
   - 访问：http://192.168.1.100:3000

---

## 🔑 推荐方案对比

| 方案 | 难度 | 费用 | 稳定性 | 适用场景 |
|------|------|------|---------|----------|
| **cpolar内网穿透** | ⭐ 极简 | 免费/付费 | ⭐⭐⭐⭐ | 个人测试、临时分享 |
| 花生壳 | ⭐⭐ 简单 | 免费/付费 | ⭐⭐⭐ | 个人使用 |
| 云服务器 | ⭐⭐⭐⭐ 较难 | ￥100+/年 | ⭐⭐⭐⭐⭐ | 企业、正式产品 |
| 局域网 | ⭐⭐ 简单 | 免费 | ⭐⭐⭐⭐⭐ | 同一WiFi内使用 |

**初学者推荐：**
1. 🥇 **最优选择**：cpolar 内网穿透（最简单，5分钟搞定）
2. 🥈 **性价比**：局域网访问（免费，但仅限同WiFi）
3. 🥉 **长期使用**：云服务器部署（最稳定，需费用）

---

### 👉 快速上手：cpolar 公网访问

```bash
# 1. 启动项目
npm run dev

# 2. 新开一个命令行窗口，运行
cpolar http 3000

# 3. 查看生成的公网地址，例如：
# https://xxxxx.r28.cpolar.top

# 4. 分享这个地址给其他人，他们就可以访问了！
```

---

---

## 🔧 常见问题

### 问题1：`npm install` 失败
**解决方案：**
```bash
# 清理缓存
npm cache clean --force

# 使用国内镜像源
npm config set registry https://registry.npmmirror.com

# 重新安装
npm install
```

### 问题2：端口 3000 被占用
**解决方案：**
```bash
# 方法1：修改端口
# 在 .env 文件中添加：PORT=3001

# 方法2：关闭占用进程（Windows）
taskkill /F /IM node.exe
```

### 问题3：服务器重启后需重新登录
**原因：** Session 存储在内存中，重启后会清空

**解决方案：** 正常现象，重新登录即可

### 问题4：图片上传后识别失败
**检查清单：**
- [ ] 已配置百度 OCR API 密钥
- [ ] `uploads/temp/` 目录存在
- [ ] 图片格式为 JPG/PNG
- [ ] 图片大小 < 5MB

### 问题5：AI 批改失败
**检查清单：**
- [ ] OpenAI API Key 配置正确
- [ ] API Key 有足够余额
- [ ] 网络可以访问 OpenAI API
- [ ] OPENAI_BASE_URL 配置正确

---

## 📁 重要文件说明

| 文件/目录 | 说明 | 是否必需 |
|---------|------|---------|
| `.env` | API密钥配置 | ✅ 必需 |
| `dev.db` | SQLite数据库 | ✅ 必需 |
| `package.json` | 依赖配置 | ✅ 必需 |
| `node_modules/` | 依赖包 | ⚠️ 可重新安装 |
| `uploads/` | 上传文件 | ⚠️ 可清空 |
| `prisma/` | 数据库配置 | ✅ 必需 |
| `src/` | 后端源代码 | ✅ 必需 |
| `public/` | 前端页面 | ✅ 必需 |

---

## 🔐 安全建议

1. **修改默认密码**
   - 登录管理员账户后立即修改密码
   - 删除或修改测试账户密码

2. **保护 API 密钥**
   - 不要将 `.env` 文件上传到公开仓库
   - 定期更换 API 密钥

3. **限制访问权限**
   - 生产环境建议配置 HTTPS
   - 使用强密码策略

---

## 📞 技术支持

- 查看数据库：`npx prisma studio`
- 查看日志：服务器启动后在命令行查看输出
- 项目目录：`c:\Users\Administrator\Desktop\Homework grading`

---

## ✅ 部署检查清单

移植完成后，请逐项检查：

- [ ] Node.js 已安装（v18+）
- [ ] 项目文件已复制完整
- [ ] `npm install` 成功执行
- [ ] `.env` 文件配置正确
- [ ] OpenAI API Key 已配置
- [ ] 数据库文件存在或已重新生成
- [ ] 服务器成功启动（`npm run dev`）
- [ ] 浏览器可访问 http://localhost:3000
- [ ] 登录功能正常
- [ ] 测试提交答案功能
- [ ] 测试支付功能（如需要）

---

**部署完成！祝使用愉快！** 🎉

*最后更新：2025年12月*
