<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰¹æ”¹è®°å½• - æ™ºèƒ½ä½œä¸šæ‰¹æ”¹ç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- æ¯›ç’ƒç’ƒé¡µå¤´ -->
    <header class="glass-header">
        <div class="header-content">
            <button class="back-btn" onclick="history.back()">
                <span>â† è¿”å›</span>
            </button>
            <div class="header-title">
                <h1>ğŸ“Š æ‰¹æ”¹è®°å½•</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="usernameDisplay"></span>
            </div>
        </div>
    </header>

    <div class="container">

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="main-content">
            <!-- è®°å½•åˆ—è¡¨ -->
            <section class="card">
                <h2 class="section-title">ğŸ“‹ æœ€è¿‘è®°å½•</h2>
                <div id="historyList" class="history-list">
                    <!-- è®°å½•å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <p class="empty-text">æš‚æ— æ‰¹æ”¹è®°å½•</p>
                        <p class="empty-hint">æäº¤ä½œä¸šåï¼Œæ‰¹æ”¹è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        <a href="submit.html" class="btn btn-primary" style="margin-top: 1rem;">å»æ‰¹æ”¹ä½œä¸š</a>
                    </div>
                </div>
                
                <!-- åˆ†é¡µå¯¼èˆª -->
                <div id="pagination" class="pagination" style="display: none;">
                    <button class="page-btn" id="prevPage">â† ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="pageInfo">1 / 1</span>
                    <button class="page-btn" id="nextPage">ä¸‹ä¸€é¡µ â†’</button>
                </div>
            </section>
        </main>

        <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="mobile-nav" id="mobileNav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="submit.html" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">æäº¤</span>
            </a>
            <a href="add-question.html" class="nav-item teacher-only" style="display: none;">
                <span class="nav-icon">â•</span>
                <span class="nav-label">æ·»åŠ </span>
            </a>
            <a href="manage-questions.html" class="nav-item teacher-only" style="display: none;">
                <span class="nav-icon">ğŸ“‹</span>
                <span class="nav-label">ç®¡ç†</span>
            </a>
            <a href="recharge.html" class="nav-item">
                <span class="nav-icon">ğŸ’°</span>
                <span class="nav-label">å……å€¼</span>
            </a>
        </nav>
    </div>

    <script src="header-utils.js"></script>
    <script>
        // API åŸºç¡€ URL
        const API_BASE = '/api/auth';
        let currentUser = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/me`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentUser = result.data;
                        displayUserInfo();
                        await loadHistory();
                    } else {
                        window.location.href = 'login.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€é”™è¯¯:', error);
                window.location.href = 'login.html';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo() {
            if (currentUser) {
                const roleText = currentUser.role === 'teacher' ? 'æ•™å¸ˆ' : 'å­¦ç”Ÿ';
                document.getElementById('usernameDisplay').textContent = `${currentUser.username} (${roleText})`;
                document.getElementById('userInfo').style.display = 'flex';
                
                // æ›´æ–°ç§»åŠ¨ç«¯å¯¼èˆªæ ï¼ˆæ•™å¸ˆæ˜¾ç¤ºé¢å¤–æŒ‰é’®ï¼‰
                updateMobileNav();
            }
        }

        // æ›´æ–°ç§»åŠ¨ç«¯å¯¼èˆªæ 
        function updateMobileNav() {
            const teacherOnlyItems = document.querySelectorAll('.mobile-nav .teacher-only');
            if (currentUser && currentUser.role === 'teacher') {
                teacherOnlyItems.forEach(item => {
                    item.style.display = 'flex';
                });
            } else {
                teacherOnlyItems.forEach(item => {
                    item.style.display = 'none';
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // åˆ†é¡µé…ç½®
        const PAGE_SIZE = 3;
        let allRecords = [];
        let currentPage = 1;
        let totalPages = 1;

        // åŠ è½½æ‰¹æ”¹è®°å½•
        async function loadHistory() {
            try {
                const response = await fetch('/api/exam/history', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    allRecords = data.records || [];
                    totalPages = Math.ceil(allRecords.length / PAGE_SIZE);
                    currentPage = 1;
                    renderCurrentPage();
                } else {
                    console.log('æš‚æ— æ‰¹æ”¹è®°å½•');
                }
            } catch (error) {
                console.log('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å½“å‰é¡µ
        function renderCurrentPage() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageRecords = allRecords.slice(start, end);
            
            renderHistory(pageRecords);
            updatePagination();
        }

        // æ›´æ–°åˆ†é¡µå¯¼èˆª
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');

            // å§‹ç»ˆæ˜¾ç¤ºåˆ†é¡µå¯¼èˆª
            pagination.style.display = 'flex';
            pageInfo.textContent = `${currentPage} / ${totalPages || 1}`;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages || totalPages <= 1;
        }

        // åˆ†é¡µæŒ‰é’®äº‹ä»¶
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderCurrentPage();
            }
        });

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(records) {
            const listEl = document.getElementById('historyList');
            
            if (!records || records.length === 0) {
                return; // ä¿æŒç©ºçŠ¶æ€æ˜¾ç¤º
            }

            listEl.innerHTML = records.map(record => `
                <div class="history-item">
                    <div class="history-info">
                        <div class="history-title">${record.questionTitle || 'ä½œä¸šæ‰¹æ”¹'}</div>
                        <div class="history-time">${record.studentName ? record.studentName + ' Â· ' : ''}${formatTime(record.createdAt)}</div>
                    </div>
                    <div class="history-score ${getScoreClass(record.score)}">
                        ${record.score}åˆ†
                    </div>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            
            return date.toLocaleDateString('zh-CN', {
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // è·å–åˆ†æ•°æ ·å¼ç±»
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 60) return 'score-pass';
            return 'score-fail';
        }
    </script>
</body>
</html>
